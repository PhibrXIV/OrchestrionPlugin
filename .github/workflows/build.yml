name: Create Release and Update Repo

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    uses: PhibrXIV/DalamudPluginRepo/.github/workflows/reusable_create_release.yml@master
    with:
      internal_name: OrchestrionPlus
      solution_name: Orchestrion
      build_configuration: Release
      personal_plugin_repo: PhibrXIV/DalamudPluginRepo
      personal_plugin_repo_branch: master
      plugin_folder: OrchestrionPlus
      project_dir: Orchestrion
      platform: x64
    secrets:
      PAT: ${{ secrets.PAT }}

  regenerate_pluginmaster:
    name: Trigger PluginMaster Regeneration
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch regenerate.yml in Plugin Repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'PhibrXIV',
              repo: 'DalamudPluginRepo',
              workflow_id: 'regenerate.yml',   // filename under .github/workflows
              ref: 'master'
            });
